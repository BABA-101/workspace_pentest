#include <windows.h>

char originalBytes[5];

FARPROC hookedAddress;

int __stdcall myFunc(LPCSTR lpCmdLine, UINT uCmdShow) {

	WriteProcessMemory(GetCurrentProcess(), (LPVOID)hookedAddress, originalBytes, 5, NULL);

	// 계산기. 후크 된 후에 notepad 실행 시 calc가 열릴 것.
	return WinExec("calc", uCmdShow);
}

void setMySuperHook() {
	HINSTANCE hLib;
	VOID* myFuncAddress;
	DWORD* rOffset;
	DWORD src;
	DWORD dst;
	CHAR patch[5] = { 0 };

	// kernel32.dll 로드
	hLib = LoadLibrary("kernel32.dll");
	// kernel32.dll에서 WinExec 함수 가져오기
	hookedAddress = GetProcAddress(hLib, "WinExec");

	ReadProcessMemory(GetCurrentProcess(), (LPCVOID)hookedAddress, originalBytes, 5, NULL);

	myFuncAddress = &myFunc;

	src = (DWORD)hookedAddress + 5;
	dst = (DWORD)myFuncAddress;
	rOffset = (DWORD*)(dst - src);

	memcpy(patch, "\xE9", 1);
	memcpy(patch + 1, &rOffset, 4);

	WriteProcessMemory(GetCurrentProcess(), (LPVOID)hookedAddress, patch, 5, NULL);

}


int main() {

	WinExec("notepad", SW_SHOWDEFAULT);

	setMySuperHook();

	WinExec("notepad", SW_SHOWDEFAULT);

}

